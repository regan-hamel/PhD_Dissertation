---
title: "8. Misc Plots"
author: "Regan"
date: "30/06/2021"
---

Area composition plot, cell type vs timepoint


Load the sce & set the directory
```{r}
sce <- sce_comp <- readRDS("/Users/reganhamel/Documents/PhD/PhD Dissertation/Chapter 3/scRNAseq/4. Cellassign/sce.RDS")


#reorder the cell types for aesthetics 
sce_comp$cell_type <- sce$cell_type <- factor(sce_comp$cell_type, levels=c("Neutrophil","Dendritic_Cells","Macrophage","Microglia"))

dirP <- "/Users/reganhamel/Documents/PhD/PhD Dissertation/Chapter 3/scRNAseq/Misc Plots/"
```

Generate the area plot (using sce_comp)
```{r}
library(tibble)
library(ggplot2)
library(plyr)


# set HC to 0
sce_comp$stage <- factor(sce_comp$stage, levels = c("HC","0", "1", "2", "3", "10", "21"))
sce_comp$stage[sce_comp$stage == "HC"] <- 0

# set the x and y values for the plot
y <- sce_comp$Cluster
x <- droplevels(factor(sce_comp$stage))

# create the df containing the x and y values
df <- as.data.frame(table(y, x))
colnames(df) <- c("y", "x", "Freq")

# create data
time <- as.numeric(levels(df$x)[df$x]) # x Axis
value <- as.numeric(df$Freq)             # y Axis
group <- df$y       # group, one shape per group
data <- data.frame(time, value, group)


# plot
# Compute percentages with dplyr
library(dplyr)
data <- data  %>%
  group_by(time, group) %>%
  summarise(n = sum(value)) %>%
  mutate(percentage = n / sum(n))

# Plot
# Plot
ggplot(data, aes(x=time, y=percentage, fill=group)) + 
  geom_area(alpha=0.7 , size=0.5, colour="black") + ylab("Fraction of Cells") + scale_x_continuous(name ="Day Post-SCI", breaks=c(0,1,2, 3, 10, 21), labels=c("0"="HC","1"="1","2"="2", "3"="3", "10"="10", "21"="21"))+ scale_fill_brewer(palette="Accent", direction=-1)


ggsave(paste0(dirP, "/Composition Area Plot cluster.png"), height=5, width=6)
```

#histogram of cell type per cluster
```{r}
library(ggplot2)
library(dplyr)


# set the x and y values for the plot
y <- sce$cell_type
x <- droplevels(factor(sce$Cluster))

# create the df containing the x and y values
df <- as.data.frame(table(y, x))
colnames(df) <- c("y", "x", "Freq")

# create data
cluster <- as.numeric(levels(df$x)[df$x]) # x Axis
value <- as.numeric(df$Freq)             # y Axis
group <- df$y       # group, one shape per group
data <- data.frame(cluster, value, group)


# plot
# Compute percentages with dplyr
data <- data  %>%
  group_by(cluster, group) %>%
  summarise(n = sum(value)) %>%
  mutate(percentage = n / sum(n))
x

# Small multiple
ggplot(data, aes(fill=group, y=value, x=cluster)) + 
  geom_bar(position="stack", stat="identity") +
  ylab("Number of Cells") + xlab("Cluster")  + 
  scale_x_discrete(limits=c(1:11)) +
  scale_fill_brewer(palette="Accent", direction=-1) 

ggsave(paste0(dirP, "/barplot_celltype_clust.png"), height=5, width=6)

```

```{r}
library(scater)
cby <- "stage"
plotUMAP(sce, colour_by=cby)
ggsave(filename = paste0(cby, ".png"), path = dirP, scale = 1, width = 8, height = 8,  dpi = 300, limitsize = TRUE)

```
#Correlation of clusters bt stages
```{r}
PCAs <- paste0("PCA_", sce$Cluster_PCA)
Corrected <- paste0("MNN_", sce_BC$Cluster)
All <- table(sce$stage, sce$Cluster)
head(All)
```

#pearson's residuals
- http://www.sthda.com/english/wiki/chi-square-test-of-independence-in-r (how to interpret)
```{r}
library(RColorBrewer)
library(corrplot)

chisq <- chisq.test(All)

# convert the z-scores (standardized residuals) to chi square values
chisq.val <- chisq$stdres * chisq$stdres

# convert the chi square values to p values
chi.p <- pchisq(chisq.val, df=1, lower.tail=FALSE) 

# correct for multiple testing:
# compare the chi square values to the bonferonni adjusted p value
bf.p <- (0.05/(nrow(All)*ncol(All)))

corrplot(chisq$stdres, p.mat=chi.p, is.cor = FALSE, sig.level = bf.p, tl.col = "black", method="color", cl.length =10 )

```


